# 基于WeBASE-Front前置服务发送交易REST接口调用可升级的智能合约方案

> 作者简介： 孙运盛 吉科软信息技术有限公司 大数据技术研究院架构师。负责吉科软区块链BaaS平台设计研发，基于FISCO BCOS的区块链技术研究以及在智慧农业、智慧城市、智慧食安行业领域的区块链技术应用研发。

## 前言

- 我司区块链BaaS平台中通过集成WeBASE-Front前置服务提供的发送交易接口实现基于REST接口形式的智能合约调用，旨在为上层业务应用提供统一的REST形式区块链交互接口，隔离业务应用与智能合约调用代码的紧耦合；
- 为实现逻辑与数据分离的可升级智能合约，采用基于代理模式的可升级智能合约开发方案，代理合约借助delegatecall+fallback的组合模式，实现对逻辑合约函数的调用，代理合约中不声明逻辑合约的函数签名，但代理合约作为上层业务应用调用的入口合约；
- WeBASE-Front前置服务的发送交易接口的交易输入参数中需指定要调用的合约名称、合约地址、合约ABI、合约函数，按照发送交易接口的交易参数中要求合约ABI和合约函数名称但代理合约为调用入口合约且无逻辑合约中的函数签名，这将给调用者带来疑惑，到底该如何利用前置服务的发送交易接口对真实逻辑合约函数的调用及交易回执的解析呢？

本文将从代理模式合约、WeBASE-Front前置服务发送交易接口说明、编写代理模式合约样例及java代码中调用的测试流程，详细描述如何利用WeBASE-Front前置服务调用基于代理模式的智能合约的方法。

## **实验环境**

| 名称         | 版本号  |
| ------------ | ------- |
| FISCO BCOS   | v2.9.0  |
| WeBASE-Front | v1.5.4  |
| Solidity     | ^0.6.10 |

## **基于代理模式的可升级智能合约**

​       在智能合约的开发过程中，对于一些复杂的合约开发，要开发出完美没有bug的智能合约，要求是相当高的。即使编写出来的智能合约能完美没有bug，也很难保证以后的需求和应用业务逻辑一成不变。所以，在开发智能合约的同时，就要考虑好以后的合约更新和升级问题。智能合约的更新和升级，其中一种思路就是：在智能合约的编写过程中，要做到数据和应用逻辑的分离。简单来说，就是把数据和应用逻辑分别放在2个独立的合约里(本文称之为数据合约和逻辑合约)。我们在升级合约时，保证存放数据的数据合约里的数据结构不改变，改变的只是存放应用逻辑的逻辑合约。这样才能保证原有的业务数据不被破坏和能够继续使用。

​       Solidity有三种合约间的调用方式 call、delegatecall 和 callcode。其中，delegatecall可作为智能合约升级的一个较好的途径。

​       代理合约将智能合约的存储合约和逻辑合约分开，代理合约存储所有相关的变量，并且保存逻辑合约的地址；所有函数存在逻辑合约里，通过delegatecall执行。当升级时，只需要将代理合约指向新的逻辑合约即可。

![截图](C:\Users\jkrtech\Desktop\新建文件夹 (2)\截图.png)

